@page "/users"
@inject NavigationManager NavigationManager
@inject UserService UserService

<PageTitle>Users</PageTitle>

<MudStack Spacing="2">
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
        <MudButton Class="pa-1" Variant="Variant.Filled" Size="Size.Medium" >
            <MudTextField @bind-Value="Search"
                          Placeholder="Search..."
                          Immediate="true"
                          DebounceInterval="300"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Clearable="true"
                          AutoFocus="true"
                          Underline="false"
            />
        </MudButton>
        <MudButton Variant="Variant.Filled" OnClick="@ReloadAsync">Reload</MudButton>
    </MudStack>

    <MudTable T="User"
              Items="_users"
              Hover="true"
              Dense="true"
              Loading="_loading"
              RowClass="cursor-pointer"
              OnRowClick="OnRowClickEvent">
        <HeaderContent>
            <MudTh>Rank</MudTh>
            <MudTh>Username</MudTh>
            <MudTh>Username2</MudTh>
            <MudTh>Unit</MudTh>
            <MudTh>Position</MudTh>
            <MudTh>Status</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="Rank">@(context.Rank?.Abbreviation ?? context.Rank?.Code ?? context.Rank?.Name)</MudTd>
            <MudTd DataLabel="Username">@context.Name</MudTd>
            <MudTd DataLabel="Username2">
                <MudLink Href="@($"/User?id={context.Id}")"
                         @onclick:stopPropagation="true">
                    @context.Name
                </MudLink>
            </MudTd>
            <MudTd DataLabel="Unit">@(context.Unit?.Abbreviation ?? context.Unit?.Name)</MudTd>
            <MudTd DataLabel="Position">@context.UnitRole</MudTd>
            <MudTd DataLabel="Status">
                @switch (context.Status) {
                    case "LOA":
                        <MudChip T="string" Color="Color.Primary">LOA</MudChip> break;
                    case "Active":
                        <MudChip T="string" Color="Color.Success">Active</MudChip> break;
                    default:
                        <MudChip T="string" Color="Color.Dark">Inactive</MudChip> break;
                }
            </MudTd>
        </RowTemplate>

        <NoRecordsContent>
            <MudText>No users found.</MudText>
        </NoRecordsContent>
    </MudTable>
</MudStack>

@code {

    private List<User> _users = [];
    private bool _loading;
    private string? _search;

    protected override async Task OnInitializedAsync() => await ReloadAsync();

    private async Task ReloadAsync() {
        _loading = true;
        try {
            _users = await UserService.GetAllAsync(_search);
        } finally {
            _loading = false;
        }
    }

    private void OnRowClickEvent(TableRowClickEventArgs<User> args) {
        if (_loading) return;
        NavigationManager.NavigateTo($"/users/{args.Item?.Id}");
    }

    private string? Search {
        get => _search;
        set {
            _search = value;
            InvokeAsync(ReloadAsync);
        }
    }

}
