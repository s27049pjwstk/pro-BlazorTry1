@inject IErrorHandler ErrorHandler
@inject IUnitService UnitService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h5">@_dialogTitleText</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" Disabled="_disabled">
            <MudTextField @bind-Value="_dto.Name"
                          Label="Name"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          MaxLength="64"
                          Validation="@ValidateNameAsync"
                          Required="true"/>
            <MudTextField @bind-Value="_dto.Abbreviation"
                          Label="Callsign"
                          Variant="Variant.Outlined"
                          MaxLength="16"
                          Validation="@ValidateAbbreviationAsync"
                          Margin="Margin.Dense"/>
            <MudTextField @bind-Value="_dto.Description"
                          Label="Description"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          MaxLength="1000"
                          Lines="4"/>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@MudDialog.Cancel">Cancel</MudButton>
        @if (Unit is not null) {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Error"
                       Disabled="@_disabled"
                       OnClick="@DeleteAsync">
                Delete
            </MudButton>
        }
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_disabled"
                   OnClick="@SaveAsync">@_submitButtonText</MudButton>
    </DialogActions>
</MudDialog>



@code {

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public Unit? Unit { get; set; }

    public enum Result {
        Created,
        Updated,
        Deleted,
        Failed
    }

    private MudForm _form = null!;
    private bool _disabled;

    private UnitDto _dto = new();
    private string _submitButtonText = "Create";
    private string _dialogTitleText = "Create New Unit";

    protected override void OnInitialized() {
        var options = MudDialog.Options with { FullWidth = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        MudDialog.SetOptionsAsync(options);

        if (Unit is null) return;
        _submitButtonText = "Save";
        _dialogTitleText = "Edit Unit";
        _dto = new UnitDto {
            Name = Unit.Name,
            Abbreviation = Unit.Abbreviation,
            Description = Unit.Description
        };
    }

    private sealed class UnitDto {
        public string Name { get; set; } = null!;
        public string? Abbreviation { get; set; }
        public string? Description { get; set; }
    }

    private async Task<string?> ValidateNameAsync(string? name) {
        if (name is null) return null;
        if (await UnitService.NameExistsAsync(name.Trim(), excludeId: Unit?.Id))
            return "A unit with this name already exists";
        return null;
    }

    private async Task<string?> ValidateAbbreviationAsync(string? name) {
        if (name is null) return null;
        if (await UnitService.AbbreviationExistsAsync(name.Trim(), excludeId: Unit?.Id))
            return "A unit with this name already exists";
        return null;
    }

    private async Task SaveAsync() {
        _dto.Name = _dto.Name.Trim();
        _dto.Abbreviation = _dto.Abbreviation?.Trim();
        _dto.Description = _dto.Description?.Trim();
        await _form.Validate();
        if (!_form.IsValid) return;

        _disabled = true;
        try {
            if (Unit is null) {
                var created = await ErrorHandler.ExecuteAsync(
                async () => await UnitService.CreateAsync(_dto.Name, _dto.Abbreviation, _dto.Description),
                "Failed to create unit.",
                null,
                true);

                if (created is not null) Snackbar.Add($"Unit {created.Name} created", Severity.Success);
                MudDialog.Close(DialogResult.Ok(Result.Created));
            } else {
                var updated = await ErrorHandler.ExecuteAsync(
                async () => await UnitService.UpdateAsync(Unit.Id, Unit.Version, _dto.Name, _dto.Abbreviation, _dto.Description),
                "Failed to update unit.",
                null,
                true);

                if (updated is null) {
                    MudDialog.Cancel(); 
                    return; 
                }
                Snackbar.Add($"Unit {updated.Name} updated", Severity.Success);
                MudDialog.Close(DialogResult.Ok(Result.Updated));
            }
        } finally {
            _disabled = false;
        }
    }

    private async Task DeleteAsync() {
        if (Unit is null) return;
        _disabled = true;
        try {
            await ErrorHandler.ExecuteAsync(() => UnitService.DeleteAsync(Unit.Id), "Failed to delete unit");
            Snackbar.Add("Unit deleted", Severity.Success);
            MudDialog.Close(DialogResult.Ok(Result.Deleted));
        } catch {
            MudDialog.Close(DialogResult.Ok(Result.Failed));
        } finally {
            _disabled = false;
        }
    }


}
